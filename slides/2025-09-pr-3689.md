---
routerMode: hash # for GH hosting
theme: default
title: Normative change PromiseResolve species check
info: |
  Normative PR 3689: use __proto__ for PromiseResolve species check
class: text-center
drawings:
  persist: false
# slide transition: https://sli.dev/guide/animations.html#slide-transitions
transition: fade
fonts:
  local: ["Consolas", "Fira Code", "monospace"]
layout: cover
---

# Normative: <br/> change `PromiseResolve` <br/> species check ([#3689](https://github.com/tc39/ecma262/pull/3689))

Mathieu Hofman (@mhofman)

---

# Motivation

User code can interfere with `Await` semantics, and disable promise adoption.

<v-click at="1">

Assuming `.then` pollution

<<< @/snippets/pr-snippet.js#then-pollution
</v-click>

<v-click at="3">

and `.constructor` pollution

<<< @/snippets/pr-snippet.js#constructor-pollution
</v-click>

<v-click at="2">

User code

````md magic-move {at: 3}
<<< @/snippets/pr-snippet.js#user-not-exploited
<<< @/snippets/pr-snippet.js#user-exploited
````
</v-click>

---

# What's happening ?

`Await` uses `PromiseResolve` to coerce the value to a `%Promise%` (that it can internally react to)

<<< @/snippets/pr-snippet.js#promise-resolve {*|*|3-4}

<v-click at="1">

It was extracted from the original implementation of `Promise.resolve`, described as:

> This function returns either a new promise resolved with the passed argument, or the argument itself if the argument is a promise produced by this constructor.

</v-click>

<br/>

<v-click at="2">

The check was meant as a sort of strict "instanceof" but uses `.constructor`.

Besides interfering with native promise adoption, user code can also observe whenever a native promise is being handled (e.g. by using a getter).

</v-click>

---

# Equivalent unobservable check

Replace with a `__proto__` check

<<< @/snippets/pr-snippet.js#promise-resolve-proposed {3-5}

Credit: Kevin Gibbons for the original idea.

<br/>

<v-click>

* Relies on the Constructor to identify its instances instead of the instance to identify its constructor.
* More similar to an `instanceof` check, without prototype chain walk.
  * Derived instances still do not qualify (stricter check than `instanceof`)

</v-click>

---

# Web compatibility

<v-click>

### Not affected

* Does not change resolution with non-native promises / thenables
* Does not change resolution with native promises created by another constructor

</v-click>

<br/>

<v-click>

### Passing through previously wrapped instances

* own `.constructor`
* Modified `Promise.prototype.constructor` property

-> No legitimate use case ? We can measure if this happens in the wild.

</v-click>

<br/>

<v-click>

### Wrapping instances previously passed through

* Promise with a different prototype than `%Promise.prototype%`, <br/>
  but which maintains a `.constructor` of `%Promise%`

-> Unlikely but safe to wrap into new `%Promise%`

</v-click>

---
layout: section
---
# Approved ?

<br/>

Unobservable native promise "type" check in `PromiseResolve`.

Reduce impact of Promise.prototype pollution on async code.

For web browser implementors: measure web compat.