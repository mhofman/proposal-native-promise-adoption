---
routerMode: hash # for GH hosting
theme: default
title: Native promise adoption for Stage 1
info: |
  Proposal for adopting native promise state.
class: text-center
drawings:
  persist: false
# slide transition: https://sli.dev/guide/animations.html#slide-transitions
transition: fade
fonts:
  local: ["Consolas", "Fira Code", "monospace"]
layout: cover
---

# Native promise adoption <br /> for Stage 1

Mathieu Hofman (@mhofman)

---

# Motivation

Promise prototype pollution has surprising / inconsistent effects on async code.

<v-click>
Pollution

<<< @/snippets/snippet.js#pollution
</v-click>

<v-click>
Library code

````md magic-move {at:'3'}
<<< @/snippets/snippet.js#library-async-no-await {*|1|*|2}
<<< @/snippets/snippet.js#library-async-await {2}
````
</v-click>

<v-click>
User code

````md magic-move {at:'4'}
<<< @/snippets/snippet.js#user-exploited {1|3|3}
<<< @/snippets/snippet.js#user-not-exploited {3}
````
</v-click>

---
layout: two-cols-header
---

# What's happening ?

````md magic-move
<<< @/snippets/snippet.js#library-async-no-await
<<< @/snippets/snippet.js#library-promise-no-await {*|*|*|*|1|2}
````

::left::

<div v-click="4">
<<< @/snippets/snippet.js#resolve-promise {*|4-5|6-7,10-17}{at: 5}
</div>

::right::

<div v-click="2">
<<< @/snippets/snippet.js#resolvers {*|8,14|8,14,17}{at: 3}
</div>

---
layout: two-cols-header
---

# What's happening ?

````md magic-move
<<< @/snippets/snippet.js#library-async-await
<<< @/snippets/snippet.js#library-promise-await {*|*|2}
````

::left::

<div v-click="2">
<<< @/snippets/snippet.js#resolve-promise {*|4-5}{at: 3}
</div>

::right::

<div v-click="2">
<<< @/snippets/snippet.js#resolvers {*|8,14,17}{at: 3}
</div>

---

# What can we do ?

<v-clicks depth="2">

* <span v-mark="{ at: 3, type: 'strike-through' }">Automatically await return in async functions?</span>
  * <span v-mark="{ at: 3, type: 'strike-through' }">Changes `try`/`catch`/`finally` semantics</span>
* Adopt result promises in async functions?
  * Most narrow solution
  * Hard to special case, but possible
* Adopt promises in resolve functions?
  * Consistent promise behavior
  * This is what Promises/A+ intended!

</v-clicks>

---
layout: iframe
url: https://promisesaplus.com/#the-promise-resolution-procedure
---

---

# What is promise adoption

- If `x` is a promise, adopt its state [^1]:
    1. If `x` is pending, `promise` must remain pending until `x` is fulfilled or rejected.
    1. If/when `x` is fulfilled, fulfill `promise` with the same value.
    1. If/when `x` is rejected, reject `promise` with the same reason.

[^1]: Generally, it will only be known that `x` is a true promise if it comes from the current implementation. This clause allows the use of implementation-specific means to adopt the state of known-conformant promises.

---
layout: two-cols-header
---

# Promise adoption in resolve function

<<< @/snippets/snippet.js#library-promise-no-await {*|2}{at: 2}

::left::

````md magic-move
<<< @/snippets/snippet.js#resolve-promise
<<< @/snippets/snippet.js#resolve-promise-proposed {*|6-9,13-20}{at: 2}
````

::right::

<<< @/snippets/snippet.js#resolvers {*|8,14,17}{at: 2}

---

# Web compatibility

<v-clicks depth="2">

* Does not affect resolution with non-native promises / thenables
* Does not change number of ticks for promise resolution
* Only affects code attempting to hijack native promise behavior
  * Malicious code
  * Possibly some async tracking libraries

</v-clicks>

---

# Web compatibility

Zone.js

<v-clicks depth="2">

* Relies on transpiling async code to avoid native promise adoption in `await`
  * a narrow `return` only solution should be safe
* Replaces global `Promise` with `ZoneAwarePromise` (implemented as a thenable)
* Replaces `Promise.prototype.then` to assimilate native promises into their zone aware promises
  * Covers explicit calls to `promise.then`
  * Doesn't expect to intercept native promise assimilating another native promise
* 262 spec does not use `PromiseCapability`'s `[[Resolve]]` with another native promise
* --> Promise adoption in resolve functions should be compatible
  * None-the-less, should measure in the wild

</v-clicks>

---
layout: section
---
# Stage 1?

<br/>

Make native promise adoption more consistent.

Reduce impact of Promise.prototype pollution on async code.

For web browser implementors: measure web compat.